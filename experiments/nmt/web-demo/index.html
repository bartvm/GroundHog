<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Neural Machine Translation</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <style type="text/css">
      /* Alignment diagram styles */
      .link {
        fill: none;
        stroke: #000;
      }

      svg text {
        font-size: 16px;
      }

      /* Website style */
      .input {
        background: #3d9eed;
        background: -moz-linear-gradient(-45deg,  #3d9eed 0%, #0d4d9b 100%);
        background: -webkit-gradient(linear, left top, right bottom, color-stop(0%,#3d9eed), color-stop(100%,#0d4d9b));
        background: -webkit-linear-gradient(-45deg,  #3d9eed 0%,#0d4d9b 100%);
        background: -o-linear-gradient(-45deg,  #3d9eed 0%,#0d4d9b 100%);
        background: -ms-linear-gradient(-45deg,  #3d9eed 0%,#0d4d9b 100%);
        background: linear-gradient(135deg,  #3d9eed 0%,#0d4d9b 100%);
        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#3d9eed', endColorstr='#0d4d9b',GradientType=1 );
        padding: 3em 0 3em 0;
      }

      .output {
        background: #265ba5;
        background: -moz-linear-gradient(45deg,  #265ba5 0%, #072754 100%);
        background: -webkit-gradient(linear, left bottom, right top, color-stop(0%,#265ba5), color-stop(100%,#072754));
        background: -webkit-linear-gradient(45deg,  #265ba5 0%,#072754 100%);
        background: -o-linear-gradient(45deg,  #265ba5 0%,#072754 100%);
        background: -ms-linear-gradient(45deg,  #265ba5 0%,#072754 100%);
        background: linear-gradient(45deg,  #265ba5 0%,#072754 100%);
        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#265ba5', endColorstr='#072754',GradientType=1 );
        font-size: 2em;
        text-align: center;
        font-style: italic;
        color: #fff;
        padding: 0.5em 0 0.5em 0;
      }

      .glyphicon {
        top: 3px;
      }

      .btn.disabled {
        opacity: 0.9;
      }

      body {
        padding-top: 50px;
        padding-bottom: 20px;
      }

      .alignment {
        overflow: auto;
        text-align: center;
        padding-top: 2em;
      }
    </style>
  </head>
  <body>
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">
            Neural Machine Translation by LISA
          </a>
        </div>
      </div>
    </div>
    <div class="input">
      <div class="container">
        <form>
          <div class="input-group input-group-lg">
            <input type="text" class="form-control" placeholder="Enter an English sentence">
            <div class="input-group-btn">
              <button data-loading-text="Translating..." type="submit" class="btn btn-default">Go!</button>
              <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                <span class="glyphicon glyphicon-cog"></span>
                <span class="sr-only">Toggle Dropdown</span>
              </button>
              <ul class="dropdown-menu" role="menu">
                <li><a href="#">Output <code>UNK</code> <span class="glyphicon glyphicon-ok pull-right"></span></a></li>
                <li class="divider"></li>
                <li role="presentation" class="dropdown-header">Beam size</li>
                <li><a href="#">1</a></li>
                <li><a href="#">2</a></li>
                <li><a href="#">3</a></li>
                <li><a href="#">4</a></li>
                <li class="active"><a href="#">5</a></li>
                <li><a href="#">6</a></li>
                <li><a href="#">7</a></li>
                <li><a href="#">8</a></li>
                <li><a href="#">9</a></li>
                <li><a href="#">10</a></li>
              </ul>
            </div>
          </div>
        </form>
      </div>
    </div>
    <div style="display:none;" class="output">
      <div class="container">
        <div class="col-md-12">
          &nbsp;
        </div>
      </div>
    </div>
    <div>
      <div class="container">
        <div class="col-md-12 alignment" style="display: none;">
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row" style="margin-top: 2em;">
        <div class="col-md-12">
          <div style="display: none;" class="alert alert-warning" role="alert">
            <strong>Unknown words!</strong> The following words are unknown to the model: <em></em>
          </div>
          <p class="lead">
            Our network was trained on a lot of data from the United Nations and the
            European Parliament, so these are the kind of sentences that it does
            well on. Give them a try!
          </p>
          <ul>
            <li>Economic growth has slowed down in recent years.</li>
            <li>The war in the Middle East is almost over.</li>
            <li>The European Parliament has decided to support the rebel factions in
              Eastern Asia, considering the recent political developments.</li>
          </ul>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4">
          <h3>How does this work?</h3>
          <p>
            <strong>Neural machine translation</strong> is a new approach to
            machine translation, where we train a single, large neural network to
            maximize the translation performance.  This is a radical departure
            from existing (phrase-based) machine translation approaches, where a
            translation system consists of many subcomponents which are optimized
            separately.
          </p>
          <p>
            This particular network uses a bidirectional recurrent neural network
            (RNN) to encode the source sentence. We call this the
            <em>encoder</em>.  A second RNN (the <em>decoder</em>) produces
            predicts the words in the target language.
          </p>
          <h3>Where does the alignment come from?</h3>
          <p>
            The model used contains performs a kind of "soft alignment", where
            the decoder (soft-)searches for parts of the input sentence which
            are most important for predicting the next word. The weights found
            during this search is what is visualized.
          </p>
        </div>
        <div class="col-md-4">
          <h3>Why does it not translate my sentence well?</h3>
          <p>
            There can be many reasons as to why our <strong>neural machine
            translation</strong> system failed to translate the phrase you asked
            it to translate. Our model is relatively small compared to
            traditional phrase-based models, and only knows 30,000 French and
            English words. If it doesn't know the words you are asking it to
            translate, it can get very confused! The model is also trained on
            domain-specific texts, so it sometimes has more trouble translating a
            simple "Hi, how are you?" than a lengthy statement on South-American
            politics.
          </p>
          <h3>Your demo doesn't work!</h3>
          <p>
            You might need a newer internet browser. We have only tested this
            demo with the latest Chrome, Firefox and IE12 browsers.
          </p>
        </div>
        <div class="col-md-4">
          <h3>What do these options mean?</h3>
          <p>
            The neural machine translation model can output <code>UNK</code> when
            it feels it needs a word which is not in its French vocabulary.  You
            can choose to discard all translations which contain
            <code>UNK</code>, or not.
          </p>
          <p>
            We use a beam-search procedure to find the translation with the
            largest likelihood. By setting the beam size larger the translations
            will be slower, but increase in quality.
          </p>
          <h3>Who made this?</h3>
          <p>
            The <strong>neural machine
            translation</strong> model was developed at LISA, the machine learning
            laboratory of the University of Montreal, mainly by
          </p>
          <ul>
            <li> KyungHyun Cho</li>
            <li> &#xC7;a&#x11F;lar G&#xFC;l&#xE7;ehre</li> 
            <li> Bart van Merri&#xEB;nboer</li>
            <li> Dzimitry Bahdanau</li>
            <li> Jean Pouget-Abadie</li>
            <li> Yoshua Bengio</li> 
          </ul>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <h3>Do you want to know more about <strong>neural machine
          translation</strong>?</h3>
          <p>
            Please, look at the following papers:
          </p>
          <ul>
            <li> D. Bahdanau, K. Cho, Y. Bengio. <a
            href="http://arxiv.org/abs/1409.0473">Neural Machine Translation
            by Jointly Learning to Align and Translate</a>. 2014.</li>
            <li> K. Cho, B. van Merrienboer, C. Gulcehre, D.  Bahdanau, F.
            Bougares, H. Schwenk, Y. Bengio. <a
            href="http://arxiv.org/abs/1406.1078">Learning Phrase
            Representations using RNN Encoder-Decoder for Statistical Machine
            Translation</a>. EMNLP 2014. </li>
            <li> K. Cho, B. van Merrienboer, D. Bahdanau, Y.  Bengio. <a
            href="http://arxiv.org/abs/1409.1259">On the Properties of Neural
            Machine Translation: Encoder-Decoder Approaches</a>. SSST-8
            2014.</li> <li> J. Pouget-Abadie, D. Bahdanau, B. van
            Merrienboer, K. Cho, Y.  Bengio. <a
            href="http://arxiv.org/abs/1409.1257">Overcoming the Curse of
            Sentence Length for Neural Machine Translation using Automatic
            Segmentation</a>. SSST-8 2014.</li>
          </ul>
        </div>
      </div>
      <hr>
      <footer>
        <p>&copy; LISA Lab, University of Montreal 2014</p>
      </footer>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
    <script>
      function poll(task_id){
        setTimeout(function(){
          $.ajax(
            "sampler.php",
            {
              data: {
                method: "task/result/" + task_id,
              },
              success: function(data) {
                //Update your dashboard gauge
                if (data['state'] == 'SUCCESS') {
                  $("button[type=submit]").button('reset');
                  var segments = data['result'][0].split("UNK");
                  if ($(".alignment").is(":hidden")) {
                    $(".alignment").slideDown();
                  }
                  drawAlignment(data['result'][2], data['result'][3],
                                data['result'][4]);
                  $(".output div").text('');
                  for (var i = 0; i < segments.length; i++) {
                    if (i > 0) {
                      $(".output div").append('<code>UNK</code>');
                    }
                    $(".output div").append(segments[i]);
                  }
                  if ($(".output").is(":hidden")) {
                    $(".output").slideDown();
                  }
                  $(".output div").fadeTo('slow', 1);

                  if (data['result'][1].length > 0) {
                    $(".alert").slideDown();
                    $(".alert em").text(data['result'][1].join(", "));
                  }
                } else if (data['state'] == 'PENDING') {
                  //Setup the next poll recursively
                  poll(task_id);
                } else {
                  $(".alert").slideDown();
                  $(".alert").text("Something went wrong. Please make sure your sentence does not contain special characters.");
                  $("button[type=submit]").button('reset');
                }
              },
              dataType: "json"
            }
          );
        }, 1000);
      };

      $("button[type=submit]").click(function() {
        $("button[type=submit]").button('loading')
        $(".output div").fadeTo('slow', 0);
        $(".alert").slideUp();
      });

      $('.dropdown-menu a').click(function(e) {
        e.stopPropagation();
        var beam_size = parseInt($(this).text());
        if (isNaN(beam_size)) {
          var span = $(this).children('span');
          $(this).data("ignore_unk", span.hasClass('glyphicon-ok'));
          span.toggleClass('glyphicon-remove');
          span.toggleClass('glyphicon-ok');
        } else {
          $(this).parent().addClass('active');
          $(this).parent().siblings().removeClass('active');
        }
      });

      $("form").submit(function(event) {
        event.preventDefault();
        $.post(
          'sampler.php',
          {
            method: 'task/async-apply/tasks.translate',
            json: JSON.stringify({
              args: [$("input[type=text]").val()],
              kwargs: {
                beam_width: parseInt($('.dropdown-menu li.active a').text()),
                ignore_unk: $('.dropdown-menu a:first').data("ignore_unk")
              },
            }),
          },
          function(data) {
            poll(data['task-id']);
          }, "json");
      });

      $('.dropdown-menu input, .dropdown label').click(function(e) {
        e.stopPropagation();
      });

      diagonal = d3.svg.diagonal()
        .source(function(d) { return {x: d.source.x, y: d.source.y}; })
        .target(function(d) { return {x: d.target.x, y: d.target.y}; });

      svg = d3.select("div.alignment").append("svg")
        .attr("width", 100)
        .attr("height", 130);

      function drawAlignment(source, target, weights) { // Weights
        $('svg').empty();
        source = $('<div/>').html(source).text().split(" ");
        target = $('<div/>').html(target).text().split(" ");
        var data = [];

        for (var i = 0; i < source.length; i++) {
          data.push({token: source[i], sentence: 'source', index: i});
        }
        for (var i = 0; i < target.length; i++) {
          data.push({token: target[i], sentence: 'target', index: i});
        }

        source_max_x = 0;
        target_max_x = 0;

        var text = svg.selectAll('text').
          data(data).
          enter().
          append('text').
          text(function(d, i) { return d.token; }).
          style('font-family', 'sans-serif').
          each(function(d, i) { d.width = this.getComputedTextLength();}).
          attr('x', function(d, i) {
            if (i > 0) {
              var prev = d3.select(this.previousSibling);
              if (prev.data()[0].sentence != d.sentence) {
                return 0;
              }
              return parseFloat(prev.attr('x')) + prev.data()[0].width + 8;
            } else {
              return 0;
            }
          }).
          each(function(d, i) {
            var x = parseFloat(d3.select(this).attr('x'));
            source_max_x = (d.sentence == 'source' ? x + d.width : source_max_x);
            target_max_x = (d.sentence == 'target' ? x + d.width : target_max_x);
          }).
          each(function(d, i) {
            var index = (d.sentence == 'source' ? i : i - source.length);
            if (index > 0) {
              var max = (d.sentence == 'source' ? source_max_x : target_max_x);
              var length = (d.sentence == 'source' ? source.length : target.length);
              var shift = (Math.max(source_max_x, target_max_x) - max) / (length - 1);
              var x = parseFloat(d3.select(this).attr('x'));
              d3.select(this).attr('x', x + shift * index);
            }
          }).
          attr('y', function(d, i) {return d.sentence == 'target' ? 120 : 20;});

        var links = [];

        for (var i = 0; i < data.length; i++) {
          if (data[i].sentence != 'source') {
            break;
          }
          for (var j = 0; j < data.length; j++) {
            if (data[j].sentence != 'target') {
              continue;
            }
            var source_x = parseFloat(d3.select(text[0][i]).attr('x')) + data[i].width / 2;
            var target_x = parseFloat(d3.select(text[0][j]).attr('x')) + data[j].width / 2;
            links.push({
              weight: weights[j - source.length][i],
              source: {
                x: source_x,
                y: 27,
              },
              target: {
                x: target_x,
                y: 102,
              },
            });
          }
        }
        $('svg').width(Math.max(source_max_x, target_max_x) + 8);

        var link = svg.selectAll(".link")
                    .data(links)
                    .enter().append("path")
                    .attr("class", "link")
                    .attr("d", diagonal)
                    .style('stroke-opacity', function(d, i) {
                      return d.weight;
                    })
                    .style('stroke-width', function(d, i) {
                      return d.weight;
                    });
      }
    </script>
  </body>
</html>
